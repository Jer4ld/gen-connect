<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messages - GenConnect</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background-color: #f5f5f5; }
        .container { display: flex; height: 100vh; }
        
        /* Sidebar Styles */
        .sidebar { position: fixed; left: 0; top: 0; width: 250px; height: 100vh; background-color: white; border-right: 1px solid #e5e7eb; padding: 20px 0; z-index: 100; }
        .sidebar-logo { padding: 0 30px 20px; border-bottom: 1px solid #e5e7eb; margin-bottom: 20px; }
        .logo { display: flex; align-items: center; gap: 10px; font-size: 20px; font-weight: 600; color: #6366f1; text-decoration: none; }
        .sidebar-nav { list-style: none; }
        .sidebar-nav li { margin: 5px 0; }
        .sidebar-nav a { display: flex; align-items: center; gap: 15px; padding: 12px 30px; text-decoration: none; color: #374151; transition: all 0.2s; font-size: 15px; }
        .sidebar-nav a:hover { background-color: #f9fafb; }
        .sidebar-nav a.active { background-color: #eff6ff; color: #2563eb; border-right: 3px solid #2563eb; }
        .sidebar-nav svg { width: 22px; height: 22px; }

        /* Messages Container */
        .messages-container { margin-left: 250px; flex: 1; display: flex; height: 100vh; background-color: #f9fafb; }
        
        /* Conversations List (Left Side) */
        .conversations-sidebar { width: 280px; background: white; border-right: 1px solid #e5e7eb; display: flex; flex-direction: column; position: relative; }
        
        /* Padding adjusted, border removed (moved to search bar) */
        .conversations-header { padding: 20px 20px 10px 20px; display: flex; justify-content: space-between; align-items: center; }
        
        .conversations-header h2 { font-size: 20px; font-weight: 700; color: #111827; }
        .header-icon { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: background-color 0.2s; color: #6b7280; }
        .header-icon:hover { background-color: #f3f4f6; }
        
        .conversations-list { flex: 1; overflow-y: auto; }
        .conversation-item { display: flex; align-items: center; gap: 12px; padding: 12px 20px; border-bottom: 1px solid #f3f4f6; text-decoration: none; color: inherit; cursor: pointer; }
        .conversation-item:hover { background-color: #f9fafb; }
        .conversation-avatar { width: 45px; height: 45px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 16px; flex-shrink: 0; overflow: hidden; }
        .conversation-name { font-weight: 600; color: #111827; font-size: 15px; }

        /* Empty State (Right Side) */
        .empty-state { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #6b7280; background: white; }
        .empty-icon svg { width: 64px; height: 64px; color: #e5e7eb; margin-bottom: 20px; }
        .empty-text { font-size: 18px; font-weight: 500; color: #374151; }

        /* Floating Dropdown Menus */
        .dropdown-menu { position: absolute; top: 60px; right: 15px; background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 8px 0; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); display: none; z-index: 1000; min-width: 180px; }
        .dropdown-menu.active { display: block; }
        .menu-item { display: flex; align-items: center; gap: 12px; padding: 10px 16px; cursor: pointer; transition: background 0.2s; color: #374151; font-size: 14px; }
        .menu-item:hover { background-color: #f9fafb; }

        /* Modals */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 3000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 12px; padding: 30px; width: 90%; max-width: 450px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h3 { font-size: 18px; font-weight: 700; color: #111827; }
        .modal-close { cursor: pointer; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; color: #6b7280; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; color: #374151; font-weight: 500; font-size: 14px; }
        .form-group input { width: 100%; padding: 12px 15px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 15px; }
        .contact-list { max-height: 200px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 8px; padding: 10px; }
        /* ⬇️ UPDATED: Added Flexbox centering for items in modals */
        .contact-item { display: flex; align-items: center; gap: 10px; padding: 10px; border-bottom: 1px solid #f3f4f6; cursor: pointer; }
        .contact-item:hover { background-color: #f9fafb; }
        .modal-actions { display: flex; gap: 10px; justify-content: flex-end; }
        .btn { padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-size: 14px; font-weight: 500; }
        .btn-cancel { background: white; border: 1px solid #d1d5db; color: #374151; }
        .btn-submit { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }

        .notification-toast { position: fixed; top: 20px; right: 20px; background: white; padding: 16px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); display: none; z-index: 5000; border-left: 4px solid #10b981; }
        .notification-toast.active { display: flex; }
    </style>
</head>
<body>

<div class="container">
    <aside class="sidebar">
        <div class="sidebar-logo">
            <a href="/" class="logo">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg><span>GenConnect</span>
            </a>
        </div>
        <ul class="sidebar-nav">
            <li><a href="{{ url_for('home') }}"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg><span>Home</span></a></li>
            <li><a href="#"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="10" r="3"/><path d="M7 20.662V19a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v1.662"/></svg><span>Explore Activities</span></a></li>
            <li><a href="#"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg><span>Community</span></a></li>
            <li><a href="{{ url_for('create_post') }}"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg><span>Create</span></a></li>
            <li><a href="/notifications"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg><span>Notification</span></a></li>
            <li><a href="{{ url_for('messages') }}" class="active"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg><span>Messages</span></a></li>
            <li><a href="{{ url_for('profile') }}"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg><span>Profile</span></a></li>
            <li><a href="{{ url_for('logout') }}"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg><span>Logout</span></a></li>
        </ul>
    </aside>

    <div class="messages-container">
        <div class="conversations-sidebar">
            <div class="conversations-header">
                <h2>Messages</h2>
                <div class="header-icon" id="conversationMenuBtn" title="More Options" onclick="toggleDropdown('conversationMenu')"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="1"/><circle cx="12" cy="5" r="1"/><circle cx="12" cy="19" r="1"/></svg></div>
            </div>
            
            <div style="padding: 0 20px 20px 20px; border-bottom: 1px solid #e5e7eb; position: relative;">
                <div style="background:#f3f4f6; padding:8px 12px; border-radius:8px; display:flex; align-items:center; gap:8px;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color:#9ca3af"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                    <input type="text" id="userSearchInput" placeholder="Search users/add users" style="border:none; background:transparent; outline:none; width:100%; font-size:14px;">
                </div>
                
                <div id="searchResults" style="display:none; position:absolute; top:100%; left:20px; right:20px; background:white; border:1px solid #e5e7eb; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.1); max-height:300px; overflow-y:auto; z-index:1000; margin-top:5px;">
                    </div>
            </div>
            <div class="dropdown-menu" id="conversationMenu">
                <div class="menu-item" onclick="openModal('addContactModal')">Add Contact</div>
                <div class="menu-item" onclick="openModal('newGroupModal')">New Group</div>
            </div>

            <div class="conversations-list">
                {% if conversations %}
                    {% for conv in conversations %}
                    <a href="/messages/{{ conv.id }}?is_group={{ 'true' if conv.is_group else 'false' }}" class="conversation-item">
                        <div class="conversation-avatar">{{ conv.name[0].upper() }}</div>
                        <div class="conversation-name">{{ conv.name }}</div>
                    </a>
                    {% endfor %}
                {% else %}
                    <div style="padding: 20px; text-align: center; color: #9ca3af;">No conversations yet.</div>
                {% endif %}
            </div>
        </div>

        <div class="empty-state">
            <div class="empty-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
            </div>
            <div class="empty-text">Select a conversation to start chatting</div>
        </div>
    </div>
</div>

<div class="modal" id="addContactModal">
    <div class="modal-content">
        <div class="modal-header"><h3>Add Contact</h3><span class="modal-close" onclick="closeModal('addContactModal')">×</span></div>
        <form id="addContactForm">
            <div class="form-group"><label>Username</label><input type="text" id="contactUsername" name="username" placeholder="Enter username" required></div>
            <div class="modal-actions"><button type="button" class="btn btn-cancel" onclick="closeModal('addContactModal')">Cancel</button><button type="submit" class="btn btn-submit">Add Contact</button></div>
        </form>
    </div>
</div>

<div class="modal" id="newGroupModal">
    <div class="modal-content">
        <div class="modal-header"><h3>Create Group</h3><span class="modal-close" onclick="closeModal('newGroupModal')">×</span></div>
        <form id="newGroupForm">
            <div class="form-group"><label>Group Name</label><input type="text" name="group_name" required></div>
            <div class="form-group"><label>Select Members</label>
                <div class="contact-list">
                {% for c in contacts %}
                <label class="contact-item" style="display: flex; align-items: center; gap: 12px; padding: 10px; cursor: pointer; border-bottom: 1px solid #f9fafb;">
                    <input type="checkbox" name="members" value="{{ c.id }}" style="width: 16px; height: 16px; cursor: pointer;">
                    
                    <div class="conversation-avatar" style="width: 36px; height: 36px; font-size: 14px;">
                        {% if c.profile_picture and c.profile_picture != 'default.jpg' %}
                            <img src="{{ url_for('static', filename='uploads/' + c.profile_picture) }}" alt="{{ c.username }}" style="width: 100%; height: 100%; object-fit: cover;">
                        {% else %}
                            {{ c.username[0].upper() }}
                        {% endif %}
                    </div>
                    
                    <span style="font-size: 14px; font-weight: 500; color: #374151;">{{ c.username }}</span>
                </label>
                {% endfor %}
            </div></div>
            <div class="modal-actions"><button type="button" class="btn btn-cancel" onclick="closeModal('newGroupModal')">Cancel</button><button type="submit" class="btn btn-submit">Create</button></div>
        </form>
    </div>
</div>

<div class="modal" id="confirmationModal">
    <div class="modal-content" style="max-width: 400px;">
        <div class="modal-header">
            <h3 id="confirmTitle">Confirm Action</h3>
            <span class="modal-close" onclick="closeModal('confirmationModal')">×</span>
        </div>
        <div style="margin-bottom: 25px;">
            <p id="confirmMessage" style="color: #4b5563; font-size: 15px; line-height: 1.5;">Are you sure?</p>
        </div>
        <div class="modal-actions">
            <button class="btn btn-cancel" onclick="closeModal('confirmationModal')">Cancel</button>
            <button class="btn btn-submit" id="confirmActionBtn">Confirm</button>
        </div>
    </div>
</div>

<div class="notification-toast" id="notificationToast"><strong id="notificationTitle"></strong>: <span id="notificationMessage"></span></div>

<script>
    let pendingAction = null;
    let pendingUsername = null;

    function toggleDropdown(id) {
        document.querySelectorAll('.dropdown-menu').forEach(m => { if(m.id !== id) m.classList.remove('active'); });
        document.getElementById(id).classList.toggle('active');
    }
    
    function openModal(id) { document.getElementById(id).classList.add('active'); }
    function closeModal(id) { document.getElementById(id).classList.remove('active'); }

    window.onclick = function(e) { if (!e.target.closest('.header-icon')) { document.querySelectorAll('.dropdown-menu').forEach(m => m.classList.remove('active')); } };

    function showNotification(type, title, message) {
        const toast = document.getElementById('notificationToast');
        document.getElementById('notificationTitle').textContent = title;
        document.getElementById('notificationMessage').textContent = message;
        toast.classList.add('active');
        setTimeout(() => toast.classList.remove('active'), 3000);
    }

    // Logic for Search + Button
    function triggerAddContactFromSearch(userId, username) {
        pendingAction = 'add_contact_search';
        pendingUsername = username;

        document.getElementById('confirmTitle').innerText = "Add Contact";
        document.getElementById('confirmMessage').innerText = `Are you sure you want to send a contact request to ${username}?`;

        const btn = document.getElementById('confirmActionBtn');
        btn.innerText = "Send Request";

        document.getElementById('confirmationModal').classList.add('active');
        document.getElementById('searchResults').style.display = 'none'; // Hide results
    }

    // Central Confirmation Handler
    document.getElementById('confirmActionBtn').addEventListener('click', async function() {
        let url = '';
        let body = null;

        if (pendingAction === 'add_contact_search') {
            url = '/add_contact';
            body = new FormData();
            body.append('username', pendingUsername);
        }

        if (!url) return;

        try {
            const res = await fetch(url, { method: 'POST', body: body });
            const data = await res.json();
            
            closeModal('confirmationModal');
            
            if (data.success) {
                showNotification('success', 'Success', data.message || 'Request sent');
            } else {
                showNotification('error', 'Error', data.message || 'Action failed');
            }
        } catch (e) {
            console.error(e);
            showNotification('error', 'Error', 'Something went wrong');
        }
    });

    // Live Search Logic with Plus Button
    const searchInput = document.getElementById('userSearchInput');
    const searchResults = document.getElementById('searchResults');
    let searchTimeout = null;

    if(searchInput) {
        searchInput.addEventListener('input', function(e) {
            const query = e.target.value.trim();
            
            if (searchTimeout) clearTimeout(searchTimeout);
            
            if (query.length === 0) {
                searchResults.style.display = 'none';
                searchResults.innerHTML = '';
                return;
            }

            searchTimeout = setTimeout(async () => {
                try {
                    const res = await fetch(`/search_users?q=${encodeURIComponent(query)}`);
                    const data = await res.json();
                    
                    searchResults.innerHTML = '';
                    
                    if (data.results.length > 0) {
                        searchResults.style.display = 'block';
                        data.results.forEach(user => {
                            const div = document.createElement('div');
                            div.style.cssText = 'padding:10px; display:flex; align-items:center; gap:10px; cursor:pointer; border-bottom:1px solid #f3f4f6;';
                            div.onmouseover = () => div.style.backgroundColor = '#f9fafb';
                            div.onmouseout = () => div.style.backgroundColor = 'white';
                            
                            // Clicking row goes to profile
                            div.onclick = () => window.location.href = `/profile/${user.username}`;
                            
                            // Added Plus Button logic
                            div.innerHTML = `
                                <div style="width:30px; height:30px; border-radius:50%; background:#e5e7eb; display:flex; align-items:center; justify-content:center; overflow:hidden;">
                                    <img src="/static/uploads/${user.profile_picture}" onerror="this.style.display='none'" style="width:100%; height:100%; object-fit:cover;">
                                    <span style="font-size:12px; font-weight:bold; color:#6b7280; display:${user.profile_picture !== 'default.jpg' ? 'none' : 'block'}">${user.username[0].toUpperCase()}</span>
                                </div>
                                <div style="flex:1;">
                                    <div style="font-size:13px; font-weight:600; color:#1f2937;">${user.username}</div>
                                    <div style="font-size:11px; color:#6b7280;">${user.fullname}</div>
                                </div>
                                <div class="add-user-btn" style="padding: 8px; cursor:pointer; color:#6366f1; border-radius:50%; display:flex; align-items:center; justify-content:center; transition:background 0.2s;"
                                     onclick="event.stopPropagation(); triggerAddContactFromSearch('${user.id}', '${user.username}')"
                                     onmouseover="this.style.backgroundColor='#e0e7ff'"
                                     onmouseout="this.style.backgroundColor='transparent'">
                                     <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                                </div>
                            `;
                            searchResults.appendChild(div);
                        });
                    } else {
                        searchResults.style.display = 'block';
                        searchResults.innerHTML = '<div style="padding:15px; text-align:center; color:#9ca3af; font-size:13px;">No users found</div>';
                    }
                } catch (err) {
                    console.error("Search failed", err);
                }
            }, 300);
        });

        document.addEventListener('click', function(e) {
            if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
                searchResults.style.display = 'none';
            }
        });
    }

    document.getElementById('newGroupForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        try {
            const res = await fetch('/create_group', { method: 'POST', body: new FormData(this) });
            const data = await res.json();
            if (data.success) { showNotification('success', 'Group Created', data.message); setTimeout(() => window.location.reload(), 2000); }
            else { showNotification('error', 'Error', data.message); }
        } catch(err) { showNotification('error', 'Error', 'Failed to create group'); }
    });

    document.getElementById('addContactForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        try {
            const res = await fetch('/add_contact', { method: 'POST', body: new FormData(this) });
            const data = await res.json();
            if (data.success) { showNotification('success', 'Status', data.message); setTimeout(() => window.location.reload(), 2500); }
            else { showNotification('error', 'Error', data.message); }
        } catch(err) { showNotification('error', 'Error', 'Failed to send request'); }
    });
</script>
</body>
</html>