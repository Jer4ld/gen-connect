<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    {% set displayName = contact.username if contact.username is defined else contact.name %}
    <title>Chat with {{ displayName }} - GenConnect</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background-color: #f5f5f5; }
        .container { display: flex; height: 100vh; }
        .sidebar { position: fixed; left: 0; top: 0; width: 250px; height: 100vh; background-color: white; border-right: 1px solid #e5e7eb; padding: 20px 0; z-index: 100; }
        .sidebar-logo { padding: 0 30px 20px; border-bottom: 1px solid #e5e7eb; margin-bottom: 20px; }
        .logo { display: flex; align-items: center; gap: 10px; font-size: 20px; font-weight: 600; color: #6366f1; text-decoration: none; }
        .sidebar-nav { list-style: none; }
        .sidebar-nav li { margin: 5px 0; }
        .sidebar-nav a { display: flex; align-items: center; gap: 15px; padding: 12px 30px; text-decoration: none; color: #374151; transition: all 0.2s; font-size: 15px; }
        .sidebar-nav a:hover { background-color: #f9fafb; }
        .sidebar-nav a.active { background-color: #eff6ff; color: #2563eb; border-right: 3px solid #2563eb; }
        .sidebar-nav svg { width: 22px; height: 22px; }
        .messages-container { margin-left: 250px; flex: 1; display: flex; height: 100vh; background-color: #f9fafb; }
        .conversations-sidebar { width: 280px; background: white; border-right: 1px solid #e5e7eb; display: flex; flex-direction: column; position: relative; }
        
        /* Conversations Header */
        .conversations-header { padding: 20px 20px 10px 20px; display: flex; justify-content: space-between; align-items: center; }
        .conversations-header h2 { font-size: 20px; font-weight: 700; color: #111827; }
        
        .header-icon { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: background-color 0.2s; color: #6b7280; }
        .header-icon:hover { background-color: #f3f4f6; }
        
        .conversations-list { flex: 1; overflow-y: auto; }
        .conversation-item { display: flex; align-items: center; gap: 12px; padding: 12px 20px; border-bottom: 1px solid #f3f4f6; text-decoration: none; color: inherit; cursor: pointer; }
        .conversation-item:hover { background-color: #f9fafb; }
        .conversation-item.active { background-color: #eff6ff; }
        .conversation-avatar { width: 45px; height: 45px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 16px; flex-shrink: 0; }
        .conversation-name { font-weight: 600; color: #111827; font-size: 15px; }
        
        .chat-area { flex: 1; display: flex; flex-direction: column; background: white; position: relative; }
        .chat-header { display: flex; align-items: center; justify-content: space-between; padding: 15px 30px; border-bottom: 1px solid #e5e7eb; background: white; z-index: 10; }
        .chat-header-info { display: flex; align-items: center; gap: 15px; }
        .chat-avatar { width: 45px; height: 45px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 16px; }
        .chat-user-info h3 { font-size: 16px; font-weight: 600; color: #111827; margin-bottom: 2px; }
        .chat-user-info p { font-size: 13px; color: #10b981; }
        .action-icon { width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: background 0.2s; color: #6b7280; }
        .action-icon:hover { background: #f3f4f6; }
        
        .pinned-message-bar { display: none; background: #f0f2f5; padding: 8px 15px; border-bottom: 1px solid #e5e7eb; align-items: center; gap: 10px; cursor: pointer; z-index: 9; }
        .pinned-icon svg { width: 18px; height: 18px; color: #00af9c; }
        .pinned-content { flex: 1; overflow: hidden; }
        .pinned-title { font-size: 12px; font-weight: bold; color: #00af9c; margin-bottom: 2px; }
        .pinned-text { font-size: 13px; color: #54656f; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .pinned-close { cursor: pointer; color: #6b7280; padding: 5px; }
        
        /* Floating Dropdowns */
        .dropdown-menu { position: absolute; top: 60px; right: 15px; background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 8px 0; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); display: none; z-index: 1000; min-width: 180px; }
        .dropdown-menu.active { display: block; }
        .menu-item { display: flex; align-items: center; gap: 12px; padding: 10px 16px; cursor: pointer; transition: background 0.2s; color: #374151; font-size: 14px; }
        .menu-item:hover { background-color: #f9fafb; }
        .menu-item.danger { color: #ef4444; }

        .messages-area { flex: 1; overflow-y: auto; padding: 20px; background: #f9fafb; }
        .message { display: flex; gap: 10px; margin-bottom: 15px; animation: fadeIn 0.3s ease; position: relative; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .message.sent { flex-direction: row-reverse; }
        .message-avatar { width: 35px; height: 35px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 14px; flex-shrink: 0; }
        .message.sent .message-avatar { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .message-content { max-width: 65%; position: relative; }
        .message-bubble { background: white; padding: 10px 14px; border-radius: 16px; border-top-left-radius: 4px; box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05); word-wrap: break-word; position: relative; }
        .message.sent .message-bubble { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-top-left-radius: 16px; border-top-right-radius: 4px; }
        .message-text { font-size: 14px; line-height: 1.5; }
        .message-meta { display: flex; align-items: center; gap: 5px; font-size: 11px; color: #9ca3af; margin-top: 4px; justify-content: flex-end; }
        .message.sent .message-meta { color: rgba(255, 255, 255, 0.8); }
        .message-options-btn { display: inline-block; margin-left: 5px; cursor: pointer; color: inherit; opacity: 0.6; font-weight: bold; font-size: 18px; line-height: 10px; visibility: hidden; }
        .message-bubble:hover .message-options-btn { visibility: visible; }
        .message-dropdown { position: absolute; top: 25px; right: 0; background: white; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.15); width: 140px; z-index: 2000; display: none; flex-direction: column; border: 1px solid #e5e7eb; overflow: hidden; }
        .message:not(.sent) .message-dropdown { left: 0; right: auto; }
        .message-dropdown.active { display: flex; }
        .msg-option-item, .option-item { padding: 10px 15px; font-size: 13px; color: #374151; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: background 0.2s; }
        .msg-option-item:hover, .option-item:hover { background-color: #f9fafb; }
        .msg-option-item.delete { color: #ef4444; }
        .reply-quote-bubble { background: rgba(0,0,0,0.08); border-left: 4px solid #00af9c; border-radius: 4px; padding: 6px 10px; margin-bottom: 6px; font-size: 12px; display: flex; flex-direction: column; color: inherit; }
        .reply-quote-sender { font-weight: bold; margin-bottom: 2px; font-size: 11px; opacity: 0.9; }
        .reaction-bar { position: absolute; top: -45px; left: 50%; transform: translateX(-50%); background: white; border-radius: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); padding: 5px; display: none; gap: 5px; z-index: 2001; }
        .reaction-bar.active { display: flex; animation: popIn 0.2s ease; }
        .reaction-emoji { cursor: pointer; padding: 4px; font-size: 18px; transition: transform 0.2s; border-radius: 50%; }
        .reaction-emoji:hover { transform: scale(1.3); background: #f3f4f6; }
        .message-reactions { display: flex; gap: 2px; position: absolute; bottom: -12px; left: 10px; background: white; border-radius: 10px; padding: 2px 4px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); font-size: 11px; z-index: 5; }
        .message.sent .message-reactions { left: auto; right: 10px; }
        .edited-label { font-size: 10px; font-style: italic; opacity: 0.7; margin-left: 4px; }
        .message-input-area { padding: 15px 20px; background: white; border-top: 1px solid #e5e7eb; position: relative; }
        .reply-preview-bar { display: none; background: #f9fafb; padding: 8px 12px; border-left: 4px solid #00af9c; border-radius: 4px; margin-bottom: 10px; justify-content: space-between; align-items: center; }
        .reply-preview-content { display: flex; flex-direction: column; font-size: 13px; width: 90%; }
        .reply-preview-name { color: #00af9c; font-weight: bold; font-size: 12px; margin-bottom: 2px; }
        .reply-preview-text { color: #54656f; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
        .reply-close { cursor: pointer; color: #6b7280; font-weight: bold; padding: 5px; }
        .message-input-container { display: flex; gap: 10px; align-items: center; }
        .attachment-button { width: 40px; height: 40px; border-radius: 50%; background: white; border: 1px solid #e5e7eb; color: #6b7280; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .input-wrapper { flex: 1; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 24px; padding: 8px 15px; display: flex; align-items: center; }
        .input-wrapper textarea { width: 100%; border: none; background: transparent; resize: none; font-size: 14px; font-family: inherit; outline: none; max-height: 100px; padding: 4px 0; }
        .send-button { width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .file-preview { display: none; align-items: center; justify-content: space-between; padding: 10px; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; margin-top: 10px; }
        .remove-file { width: 24px; height: 24px; border-radius: 50%; background: #ef4444; color: white; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 3000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 12px; padding: 30px; width: 90%; max-width: 450px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h3 { font-size: 18px; font-weight: 700; color: #111827; }
        .modal-close { cursor: pointer; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: background-color 0.2s; font-size: 24px; color: #6b7280; }
        .modal-close:hover { background-color: #f3f4f6; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; color: #374151; font-weight: 500; font-size: 14px; }
        .form-group input { width: 100%; padding: 12px 15px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 15px; }
        .form-group input:focus { outline: none; border-color: #6366f1; box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1); }
        .modal-actions { display: flex; gap: 10px; justify-content: flex-end; }
        .btn { padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-size: 14px; font-weight: 500; }
        .btn-cancel { background: white; border: 1px solid #d1d5db; color: #374151; }
        .btn-submit { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .contact-list { max-height: 300px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 8px; margin-top: 10px; }
        .contact-item { display: flex; align-items: center; gap: 10px; padding: 10px; border-bottom: 1px solid #f3f4f6; }
        .contact-checkbox { width: 18px; height: 18px; cursor: pointer; }
        .contact-avatar { width: 35px; height: 35px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 14px; }
        .contact-name { font-size: 14px; color: #374151; }

        .info-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 3000; display: none; align-items: center; justify-content: center; }
        .info-modal.active { display: flex; }
        .info-card { background: white; width: 300px; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.2); }
        .info-header { background: #f0f2f5; padding: 15px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; font-weight: bold; }
        .info-body { padding: 20px; }
        .info-row { display: flex; align-items: center; margin-bottom: 15px; font-size: 14px; }
        .info-icon { margin-right: 10px; width: 20px; text-align: center; }
        .double-tick { color: #53bdeb; font-weight: bold; } 
        .grey-tick { color: #8696a0; font-weight: bold; }
        .notification-toast { position: fixed; top: 20px; right: 20px; background: white; padding: 16px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); display: none; align-items: center; gap: 12px; z-index: 5000; animation: slideIn 0.3s ease; }
        .notification-toast.active { display: flex; }
        .notification-toast.success { border-left: 4px solid #10b981; }
        .notification-toast.error { border-left: 4px solid #ef4444; }
        .notification-icon svg { width: 20px; height: 20px; color: #10b981; }
        .notification-content { flex: 1; }
        .notification-title { font-weight: 600; font-size: 14px; color: #111827; margin-bottom: 2px; }
        .notification-message { font-size: 13px; color: #6b7280; }
        @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* ‚¨áÔ∏è ADMIN & MODAL STYLES (Added to support the features) */
        .member-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #f3f4f6; }
        .badge-admin { background: #fee2e2; color: #ef4444; font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: bold; }
        /* New Badge Style */
        .badge-member { 
            background: #e5e7eb; 
            color: #374151; 
            font-size: 10px; 
            padding: 2px 6px; 
            border-radius: 4px; 
            font-weight: bold; 
            border: 1px solid #d1d5db;
        }

        /* Red Button for Dangerous Actions */
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        .btn-danger:hover {
            background: #dc2626;
        }
        .badge-admin.hidden { visibility: hidden; }
        .promote-link { font-size: 11px; color: #6366f1; cursor: pointer; text-decoration: underline; }
    </style>
</head>
<body>

<div class="container">
    <aside class="sidebar">
        <div class="sidebar-logo">
            <a href="/" class="logo">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg><span>GenConnect</span>
            </a>
        </div>
        <ul class="sidebar-nav">
            <li><a href="/home"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg><span>Home</span></a></li>
            <li><a href="#"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="10" r="3"/><path d="M7 20.662V19a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v1.662"/></svg><span>Explore Activities</span></a></li>
            <li><a href="#"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg><span>Community</span></a></li>
            <li><a href="#"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg><span>Create</span></a></li>
            <li><a href="/notifications"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg><span>Notification</span></a></li>
            <li><a href="/messages" class="active"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg><span>Messages</span></a></li>
            <li><a href="/profile"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg><span>Profile</span></a></li>
            <li><a href="/logout"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg><span>Logout</span></a></li>
        </ul>
    </aside>

    <div class="messages-container">
        <div class="conversations-sidebar">
            <div class="conversations-header">
                <h2>Messages</h2>
                <div class="header-icon" id="conversationMenuBtn" title="More Options" onclick="toggleDropdown('conversationMenu')"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="1"/><circle cx="12" cy="5" r="1"/><circle cx="12" cy="19" r="1"/></svg></div>
            </div>
            
            <div style="padding: 0 20px 20px 20px; border-bottom: 1px solid #e5e7eb; position: relative;">
                <div style="background:#f3f4f6; padding:8px 12px; border-radius:8px; display:flex; align-items:center; gap:8px;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color:#9ca3af"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                    <input type="text" id="userSearchInput" placeholder="Search users/add users" style="border:none; background:transparent; outline:none; width:100%; font-size:14px;">
                </div>
                
                <div id="searchResults" style="display:none; position:absolute; top:100%; left:20px; right:20px; background:white; border:1px solid #e5e7eb; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.1); max-height:300px; overflow-y:auto; z-index:1000; margin-top:5px;">
                    </div>
            </div>
            <div class="dropdown-menu" id="conversationMenu">
                <div class="menu-item" onclick="openAddContactModal()"><span>Add Contact</span></div>
                <div class="menu-item" onclick="openNewGroupModal()"><span>New Group</span></div>
            </div>

            <div class="conversations-list">
                {% if conversations %}
                    {% for conv in conversations %}
                    <a href="/messages/{{ conv.id }}?is_group={{ 'true' if conv.is_group else 'false' }}" 
                       class="conversation-item {% if (is_group and conv.is_group and conv.id == contact.id) or (not is_group and not conv.is_group and conv.id == contact.id) %}active{% endif %}">
                        <div class="conversation-avatar">{{ conv.name[0].upper() }}</div>
                        <div class="conversation-name">{{ conv.name }}</div>
                    </a>
                    {% endfor %}
                {% else %}
                    <div style="padding: 20px; text-align: center; color: #9ca3af;">No conversations yet.</div>
                {% endif %}
            </div>
        </div>

        <div class="chat-area">
            <div class="chat-header">
                <div class="chat-header-info">
                    <div class="chat-avatar">{{ displayName[0].upper() }}</div>
                    <div class="chat-user-info">
                        <h3>{{ displayName }}</h3>
                        {% if contact.username is defined %}<p>‚óè Active</p>{% endif %}
                    </div>
                </div>
                <div class="action-icon" id="moreOptionsBtn" title="More Options" onclick="toggleDropdown('optionsMenu')">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="1"/><circle cx="12" cy="5" r="1"/><circle cx="12" cy="19" r="1"/></svg>
                </div>
            </div>

            <div class="pinned-message-bar" id="pinnedMessageBar">
                <div class="pinned-icon"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="17" x2="12" y2="22"/><path d="M5 17h14v-1.76a2 2 0 0 0-1.11-1.79l-1.78-.9A2 2 0 0 1 15 10.76V6h1a2 2 0 0 0 0-4H8a2 2 0 0 0 0 4h1v4.76a2 2 0 0 1-1.11 1.79l-1.78.9A2 2 0 0 0 5 15.24Z"/></svg></div>
                <div class="pinned-content" onclick="scrollToPinned()">
                    <div class="pinned-title">Pinned Message</div>
                    <div class="pinned-text" id="pinnedTextContent"></div>
                </div>
                <div class="pinned-close" onclick="unpinMessage()">‚úï</div>
            </div>

            <div class="dropdown-menu" id="optionsMenu">
                {% if is_group %}
                    <div class="menu-item" onclick="openGroupInfo()">Group Info</div>
                    {% if user_is_admin %}
                    <div class="menu-item" onclick="openEditName()">Edit Group Name</div>
                    <div class="menu-item" onclick="openAddMembersModal()">Add Users</div>
                    <div class="menu-item danger" onclick="openRemoveMembersModal()" style="color: #ef4444;">Remove Users</div>
                    {% endif %}
                    <div class="menu-item danger" onclick="confirmDeleteGroup()" style="color:#ef4444;">Delete & Exit Group</div>
                {% else %}
                    <div class="menu-item" id="btn-remove-contact" onclick="removeContact('{{ contact.id }}')">Remove Contact</div>
                    <div class="menu-item report-option" id="btn-report-user">Report User</div>
                {% endif %}
            </div>

            <div class="messages-area" id="messagesArea">
                {% if messages %}
                    {% for message in messages %}
                        <div class="message {% if message.sender_id == current_user.id %}sent{% endif %}" id="msg-{{ message.id }}">
                            <div class="message-content">
                                {% if is_group and message.sender_id != current_user.id %}
                                    <div style="font-size: 11px; color: #6b7280; margin-bottom: 2px; margin-left: 2px;">{{ message.sender.username }}</div>
                                {% endif %}

                                <div class="message-bubble">
                                    <div class="message-text" data-content-id="{{ message.id }}">{{ message.content | safe }}</div>
                                    
                                    {% if message.file_path %}
                                        <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(0,0,0,0.1);">
                                            <a href="{{ url_for('static', filename='uploads/' + message.file_path) }}" target="_blank" style="text-decoration: none; color: inherit; display: flex; align-items: center; gap: 8px; font-weight: 500; font-size: 13px;">
                                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/><polyline points="13 2 13 9 20 9"/></svg>
                                                <span>View Attachment</span>
                                            </a>
                                        </div>
                                    {% endif %}
                                    <div class="message-reactions" id="reactions-{{ message.id }}" style="display: none;"></div>
                                    
                                    <div class="message-meta">
                                        <span>{{ message.created_at.strftime('%H:%M') }}</span>
                                        <span class="message-options-btn" onclick="toggleMessageMenu(event, '{{ message.id }}')">...</span>
                                    </div>
                                </div>
                                
                                <div class="message-dropdown" id="menu-{{ message.id }}">
                                    <div class="msg-option-item" onclick="showMessageInfo('{{ message.id }}')">Message Info</div>
                                    <div class="msg-option-item" onclick="startReply('{{ message.id }}')">Reply</div>
                                    <div class="msg-option-item" onclick="showReactionPicker(event, '{{ message.id }}')">React</div>
                                    <div class="msg-option-item" onclick="pinMessage('{{ message.id }}')">Pin</div>
                                    {% if message.sender_id == current_user.id %}
                                        <div class="msg-option-item" onclick="startEdit('{{ message.id }}')">Edit</div>
                                        <div class="msg-option-item delete" onclick="deleteMessage('{{ message.id }}')">Delete</div>
                                    {% endif %}
                                </div>

                                <div class="reaction-bar" id="react-bar-{{ message.id }}">
                                    <span class="reaction-emoji" onclick="addReaction('{{ message.id }}', 'üëç')">üëç</span>
                                    <span class="reaction-emoji" onclick="addReaction('{{ message.id }}', '‚ù§Ô∏è')">‚ù§Ô∏è</span>
                                    <span class="reaction-emoji" onclick="addReaction('{{ message.id }}', 'üòÇ')">üòÇ</span>
                                    <span class="reaction-emoji" onclick="addReaction('{{ message.id }}', 'üòÆ')">üòÆ</span>
                                    <span class="reaction-emoji" onclick="addReaction('{{ message.id }}', 'üò¢')">üò¢</span>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <div style="text-align: center; padding: 40px; color: #9ca3af;">No messages yet.</div>
                {% endif %}
            </div>

            <div class="message-input-area">
                <div class="reply-preview-bar" id="replyPreview">
                    <div class="reply-preview-content">
                        <span class="reply-preview-name" id="replyTargetUser">Replying to message</span>
                        <span class="reply-preview-text" id="replyTargetText"></span>
                    </div>
                    <div class="reply-close" onclick="cancelReply()">‚úï</div>
                </div>

                <form id="messageForm" class="message-input-container" enctype="multipart/form-data">
                    <input type="file" id="fileInput" name="file" style="display: none;">
                    <button type="button" class="attachment-button" onclick="document.getElementById('fileInput').click()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                    </button>
                    <div class="input-wrapper">
                        <textarea id="messageInput" name="content" placeholder="Type a message..." rows="1"></textarea>
                    </div>
                    <input type="hidden" name="receiver_id" value="{{ contact.id }}">
                    <input type="hidden" name="is_group" value="{{ 'true' if is_group else 'false' }}">
                    <button type="submit" class="send-button" id="submitBtn">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
                    </button>
                </form>
                <div class="file-preview" id="filePreview" style="display: none;">
                    <div class="file-info"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/><polyline points="13 2 13 9 20 9"/></svg> <span id="fileName"></span></div>
                    <button type="button" class="remove-file" onclick="removeFile()">√ó</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="info-modal" id="messageInfoModal">
    <div class="info-card">
        <div class="info-header"><span>Message Info</span><span class="modal-close" onclick="closeMessageInfo()">‚úï</span></div>
        <div class="info-body">
            <div class="info-row"><span class="info-icon double-tick">‚úì‚úì</span><span>Read on</span><span style="margin-left:auto;">-</span></div>
            <div class="info-row"><span class="info-icon grey-tick">‚úì‚úì</span><span>Delivered on</span><span style="margin-left:auto;" id="infoTime"></span></div>
        </div>
    </div>
</div>

<div class="notification-toast" id="notificationToast">
    <div class="notification-icon"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg></div>
    <div class="notification-content"><div class="notification-title" id="notificationTitle"></div><div class="notification-message" id="notificationMessage"></div></div>
</div>

<div class="modal" id="groupInfoModal">
    <div class="modal-content">
        <div class="modal-header"><h3>Group Info</h3><span class="modal-close" onclick="closeModal('groupInfoModal')">√ó</span></div>
        <div style="margin-bottom: 15px; font-size: 14px; color: #6b7280;">Total Members: {{ member_count }}</div>
        <div class="contact-list">
            {% for member in group_members %}
                <div class="member-row" style="padding: 10px;">
                    <div style="display:flex; align-items:center; gap:10px;">
                        {% if member.is_admin %}
                            <div class="badge-admin">ADMIN</div>
                        {% else %}
                            <div class="badge-member">MEMBER</div>
                        {% endif %}
                        
                        <span style="font-size:14px;">{{ member.username }}</span>
                    </div>
                    
                    {% if user_is_admin and member.id != current_user.id %}
                        {% if not member.is_admin %}
                            <span class="promote-link" onclick="triggerPromote('{{ member.id }}', '{{ member.username }}')">Promote Admin</span>
                        {% else %}
                            <span class="promote-link" style="color: #ef4444;" onclick="triggerDismiss('{{ member.id }}', '{{ member.username }}')">Dismiss Admin</span>
                        {% endif %}
                    {% endif %}
                </div>
            {% endfor %}
        </div>
    </div>
</div>

<div class="modal" id="confirmationModal">
    <div class="modal-content" style="max-width: 400px;">
        <div class="modal-header">
            <h3 id="confirmTitle">Confirm Action</h3>
            <span class="modal-close" onclick="closeModal('confirmationModal')">√ó</span>
        </div>
        <div style="margin-bottom: 25px;">
            <p id="confirmMessage" style="color: #4b5563; font-size: 15px; line-height: 1.5;">Are you sure?</p>
        </div>
        <div class="modal-actions">
            <button class="btn btn-cancel" onclick="closeModal('confirmationModal')">Cancel</button>
            <button class="btn" id="confirmActionBtn">Confirm</button>
        </div>
    </div>
</div>

<div class="modal" id="editNameModal">
    <div class="modal-content">
        <div class="modal-header"><h3>Edit Group Name</h3><span class="modal-close" onclick="closeModal('editNameModal')">√ó</span></div>
        <form id="editGroupNameForm">
            <div class="form-group"><input type="text" name="new_name" value="{{ displayName }}" required></div>
            <div class="modal-actions"><button type="submit" class="btn btn-submit">Update Name</button></div>
        </form>
    </div>
</div>

<div class="modal" id="addContactModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Add Contact</h3>
            <span class="modal-close" onclick="closeAddContactModal()">√ó</span>
        </div>
        <form id="addContactForm">
            <div class="form-group">
                <label>Username</label>
                <input type="text" id="contactUsername" name="username" placeholder="Enter username" required>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-cancel" onclick="closeAddContactModal()">Cancel</button>
                <button type="submit" class="btn btn-submit" id="addContactBtn">Add Contact</button>
            </div>
        </form>
    </div>
</div>

<div class="modal" id="newGroupModal">
    <div class="modal-content">
        <div class="modal-header"><h3>Create Group</h3><span class="modal-close" onclick="closeNewGroupModal()">√ó</span></div>
        <form id="newGroupForm">
            <div class="form-group"><label>Name</label><input type="text" id="groupName" name="group_name" required></div>
            <div class="form-group"><label>Members</label><div class="contact-list">{% for c in contacts %}<label class="contact-item"><input type="checkbox" name="members" value="{{ c.id }}"> <span style="margin-left:8px">{{ c.username }}</span></label>{% endfor %}</div></div>
            <div class="modal-actions"><button type="button" class="btn btn-cancel" onclick="closeNewGroupModal()">Cancel</button><button type="submit" class="btn btn-submit" id="createGroupBtn">Create</button></div>
        </form>
    </div>
</div>

<div class="modal" id="removeMembersModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Remove Users</h3>
            <span class="modal-close" onclick="closeModal('removeMembersModal')">√ó</span>
        </div>
        <form id="removeMembersForm">
            <input type="hidden" name="group_id" value="{{ contact.id }}">
            <div class="form-group">
                <label>Select members to remove:</label>
                <div class="contact-list" style="max-height: 250px;">
                    {% for member in group_members %}
                        {% if member.id != current_user.id %}
                        <label class="contact-item">
                            <input type="checkbox" name="member_ids" value="{{ member.id }}" class="remove-checkbox"> 
                            <span style="margin-left:8px">{{ member.username }}</span>
                        </label>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-cancel" onclick="closeModal('removeMembersModal')">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="triggerBulkRemove()">Remove Selected</button>
            </div>
        </form>
    </div>
</div>

<div class="modal" id="addMembersModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Add Users</h3>
            <span class="modal-close" onclick="closeModal('addMembersModal')">√ó</span>
        </div>
        <form id="addMembersForm">
            <input type="hidden" name="group_id" value="{{ contact.id }}">
            <div class="form-group">
                <label>Select contacts to add:</label>
                <div class="contact-list" style="max-height: 250px;">
                    {% set existing_ids = group_members|map(attribute='id')|list %}
                    {% set has_candidates = false %}
                    
                    {% for c in contacts %}
                        {% if c.id not in existing_ids %}
                            {% set has_candidates = true %}
                            <label class="contact-item" style="cursor: pointer; padding: 8px 5px;">
                                <input type="checkbox" name="member_ids" value="{{ c.id }}" class="add-checkbox" style="width: 16px; height: 16px; margin-right: 12px; cursor: pointer;">
                                
                                <div style="width: 36px; height: 36px; border-radius: 50%; overflow: hidden; margin-right: 12px; border: 1px solid #e5e7eb; display: flex; align-items: center; justify-content: center; background: #f3f4f6;">
                                    {% if c.profile_picture and c.profile_picture != 'default.jpg' %}
                                        <img src="{{ url_for('static', filename='uploads/' + c.profile_picture) }}" alt="{{ c.username }}" style="width: 100%; height: 100%; object-fit: cover;">
                                    {% else %}
                                        <span style="font-size: 14px; font-weight: 600; color: #6b7280;">{{ c.username[0].upper() }}</span>
                                    {% endif %}
                                </div>
                                
                                <span style="font-size: 14px; font-weight: 500; color: #374151;">{{ c.username }}</span>
                            </label>
                        {% endif %}
                    {% endfor %}
                    
                    {% if not has_candidates %}
                        <div style="color:#9ca3af; text-align:center; padding:20px; font-size: 14px;">All your contacts are already in this group.</div>
                    {% endif %}
                </div>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-cancel" onclick="closeModal('addMembersModal')">Cancel</button>
                <button type="button" class="btn btn-submit" onclick="triggerAddMembers()">Add Selected</button>
            </div>
        </form>
    </div>
</div>

<script>
    let isEditing = false;
    let editingId = null;
    let isReplying = false;
    let replyText = "";
    let currentQuoteHtml = "";
    let pinnedMessageId = null;

    // --- TOGGLE MENUS (Floating) ---
    function toggleDropdown(id) {
        document.querySelectorAll('.dropdown-menu').forEach(m => { if(m.id !== id) m.classList.remove('active'); });
        document.getElementById(id).classList.toggle('active');
    }
    
    // Header Menus
    const moreOptionsBtn = document.getElementById('moreOptionsBtn');
    if (moreOptionsBtn) {
        moreOptionsBtn.onclick = (e) => { e.stopPropagation(); toggleDropdown('optionsMenu'); };
    }
    const conversationMenuBtn = document.getElementById('conversationMenuBtn');
    if (conversationMenuBtn) {
        conversationMenuBtn.onclick = (e) => { e.stopPropagation(); toggleDropdown('conversationMenu'); };
    }

    // Listeners for Remove/Report
    const btnRemove = document.getElementById('btn-remove-contact');
    if (btnRemove) { btnRemove.onclick = () => removeContact(btnRemove.dataset.id); }
    const btnReport = document.getElementById('btn-report-user');
    if (btnReport) { btnReport.onclick = () => reportUser(); }

    document.addEventListener('click', (e) => { 
        if (!e.target.closest('.header-icon') && !e.target.closest('.action-icon') && !e.target.closest('.message-options-btn')) {
            document.querySelectorAll('.message-dropdown, .dropdown-menu').forEach(m => m.classList.remove('active')); 
        }
        document.querySelectorAll('.reaction-bar').forEach(r => r.classList.remove('active')); 
    });

    // ‚¨áÔ∏è NEW MODAL HELPERS
    function openGroupInfo() { document.getElementById('groupInfoModal').classList.add('active'); }
    function openEditName() { document.getElementById('editNameModal').classList.add('active'); }
    function closeModal(id) { document.getElementById(id).classList.remove('active'); }

    // ‚¨áÔ∏è NEW ADMIN ACTIONS & CONFIRMATION LOGIC
    let pendingAction = null;
    let pendingUserId = null;
    let pendingUsername = null; // New for search add

    // Open the selection modal
    function openRemoveMembersModal() {
        // Reset checkboxes
        document.querySelectorAll('.remove-checkbox').forEach(cb => cb.checked = false);
        toggleDropdown('optionsMenu'); // Close the menu
        document.getElementById('removeMembersModal').classList.add('active');
    }

    // ‚¨áÔ∏è NEW: Open Add Members Modal
    function openAddMembersModal() {
        document.querySelectorAll('.add-checkbox').forEach(cb => cb.checked = false);
        toggleDropdown('optionsMenu');
        document.getElementById('addMembersModal').classList.add('active');
    }

    // Trigger the confirmation for bulk removal
    function triggerBulkRemove() {
        const checkboxes = document.querySelectorAll('.remove-checkbox:checked');
        if (checkboxes.length === 0) {
            showNotification('error', 'Selection', 'Please select at least one user.');
            return;
        }

        pendingAction = 'bulk_remove';
        
        // Custom confirmation message
        const count = checkboxes.length;
        document.getElementById('confirmTitle').innerText = "Remove Users";
        document.getElementById('confirmMessage').innerText = `Are you sure you want to remove ${count} selected user(s) from the group?`;
        
        const btn = document.getElementById('confirmActionBtn');
        btn.className = 'btn btn-danger';
        btn.innerText = "Remove Users";
        
        closeModal('removeMembersModal');
        document.getElementById('confirmationModal').classList.add('active');
    }

    // ‚¨áÔ∏è NEW: Trigger Add Members Confirmation
    function triggerAddMembers() {
        const checkboxes = document.querySelectorAll('.add-checkbox:checked');
        if (checkboxes.length === 0) {
            showNotification('error', 'Selection', 'Please select at least one user.');
            return;
        }

        pendingAction = 'add_members';
        
        const count = checkboxes.length;
        document.getElementById('confirmTitle').innerText = "Add Users";
        document.getElementById('confirmMessage').innerText = `Are you sure you want to add ${count} selected user(s) to the group?`;
        
        const btn = document.getElementById('confirmActionBtn');
        btn.className = 'btn btn-submit';
        btn.innerText = "Add Users";
        
        closeModal('addMembersModal');
        document.getElementById('confirmationModal').classList.add('active');
    }

    function triggerPromote(userId, username) {
        pendingAction = 'promote';
        pendingUserId = userId;
        
        document.getElementById('confirmTitle').innerText = "Promote Member";
        document.getElementById('confirmMessage').innerText = `Are you sure you want to promote ${username} to Admin? They will be able to manage the group settings.`;
        
        const btn = document.getElementById('confirmActionBtn');
        btn.className = 'btn btn-submit';
        btn.innerText = "Promote";
        
        closeModal('groupInfoModal');
        document.getElementById('confirmationModal').classList.add('active');
    }

    function triggerDismiss(userId, username) {
        pendingAction = 'dismiss';
        pendingUserId = userId;
        
        document.getElementById('confirmTitle').innerText = "Dismiss Admin";
        document.getElementById('confirmMessage').innerText = `Are you sure you want to remove ${username} as Admin? They will become a regular member.`;
        
        const btn = document.getElementById('confirmActionBtn');
        btn.className = 'btn btn-danger';
        btn.innerText = "Dismiss";
        
        closeModal('groupInfoModal');
        document.getElementById('confirmationModal').classList.add('active');
    }

    // ‚¨áÔ∏è NEW TRIGGER FOR SEARCH RESULTS
    function triggerAddContactFromSearch(userId, username) {
        pendingAction = 'add_contact_search';
        pendingUserId = userId;
        pendingUsername = username;

        document.getElementById('confirmTitle').innerText = "Add Contact";
        document.getElementById('confirmMessage').innerText = `Are you sure you want to send a contact request to ${username}?`;

        const btn = document.getElementById('confirmActionBtn');
        btn.className = 'btn btn-submit';
        btn.innerText = "Send Request";

        document.getElementById('confirmationModal').classList.add('active');
        document.getElementById('searchResults').style.display = 'none'; // Hide results
    }


    // ‚¨áÔ∏è UPDATE: Central Confirmation Handler
    document.getElementById('confirmActionBtn').addEventListener('click', async function() {
        let url = '';
        let body = null;
        let isFormData = false;

        if (pendingAction === 'promote') {
            url = '/promote_admin/{{ contact.id }}/' + pendingUserId;
        } else if (pendingAction === 'dismiss') {
            url = '/dismiss_admin/{{ contact.id }}/' + pendingUserId;
        } else if (pendingAction === 'bulk_remove') {
            url = '/remove_members';
            body = new FormData(document.getElementById('removeMembersForm'));
            isFormData = true;
        } else if (pendingAction === 'add_members') {
            // ‚¨áÔ∏è NEW: Handle Add Members to Group
            url = '/add_group_members';
            body = new FormData(document.getElementById('addMembersForm'));
            isFormData = true;
        } else if (pendingAction === 'add_contact_search') {
            url = '/add_contact';
            body = new FormData();
            body.append('username', pendingUsername);
            isFormData = true;
        }

        if (!url) return;

        try {
            const options = { method: 'POST' };
            if (isFormData) options.body = body;

            const res = await fetch(url, options);
            const data = await res.json();
            
            closeModal('confirmationModal');
            
            if (data.success) {
                showNotification('success', 'Success', data.message || 'Action completed successfully');
                if (pendingAction !== 'add_contact_search') {
                     setTimeout(() => window.location.reload(), 1000);
                }
            } else {
                showNotification('error', 'Error', data.message || 'Action failed');
                // Re-open modals if failed based on action type
                if(pendingAction === 'bulk_remove') setTimeout(() => document.getElementById('removeMembersModal').classList.add('active'), 500);
                else if(pendingAction === 'add_members') setTimeout(() => document.getElementById('addMembersModal').classList.add('active'), 500);
                else if (pendingAction === 'promote' || pendingAction === 'dismiss') setTimeout(() => openGroupInfo(), 500);
            }
        } catch (e) {
            console.error(e);
            showNotification('error', 'Error', 'Something went wrong');
        }
    });

    async function confirmDeleteGroup() {
        if(confirm("Are you sure you want to delete and exit this group?")) {
            const res = await fetch('/leave_group/{{ contact.id }}', { method: 'POST' });
            const data = await res.json();
            if(data.success) { showNotification('success', 'Exited', data.message); setTimeout(() => window.location.href = '/messages', 1500); }
        }
    }

    document.getElementById('editGroupNameForm').onsubmit = async function(e) {
        e.preventDefault();
        const res = await fetch('/edit_group_name/{{ contact.id }}', { method: 'POST', body: new FormData(this) });
        const data = await res.json();
        if(data.success) { showNotification('success', 'Updated', data.message); setTimeout(() => window.location.reload(), 1500); }
    };

    async function removeContact(id) {
        if(confirm("Are you sure you want to remove this contact? WARNING: All chat history and data will be permanently deleted.")) {
            try {
                const res = await fetch('/remove_contact/' + id, {method: 'POST'});
                if((await res.json()).success) window.location.href = '/messages';
            } catch(e) {}
        }
    }

    function reportUser() { alert("User reported. Thank you for keeping the community safe."); document.getElementById('optionsMenu').classList.remove('active'); }

    function showMessageInfo(id) {
        const timeEl = document.querySelector(`#msg-${id} .message-meta span`);
        document.getElementById('infoTime').innerText = timeEl ? timeEl.innerText : "Unknown";
        document.getElementById('messageInfoModal').classList.add('active');
    }
    function closeMessageInfo() { document.getElementById('messageInfoModal').classList.remove('active'); }

    function startReply(id) {
        isReplying = true;
        isEditing = false;
        const msgEl = document.querySelector(`[data-content-id="${id}"]`);
        let text = msgEl ? msgEl.innerText : "";
        let cleanText = text.replace(/Replying to message[\s\S]*?\n/, '').trim();
        cleanText = cleanText.replace('üìé View Attachment', '').trim();
        cleanText = cleanText.replace(/\(edited\)$/, '').trim();
        replyText = cleanText;
        
        document.getElementById('replyTargetUser').innerText = "Replying to message";
        document.getElementById('replyTargetText').innerText = cleanText;
        document.getElementById('replyPreview').style.display = 'flex';
        document.getElementById('messageInput').focus();
    }
    function cancelReply() { 
        isReplying = false; 
        isEditing = false;
        editingId = null;
        document.getElementById('replyPreview').style.display = 'none'; 
        replyText = ""; 
        document.getElementById('messageInput').value = ""; // Clear input if canceling edit
    }

    function toggleMessageMenu(e, id) { e.stopPropagation(); document.querySelectorAll('.message-dropdown').forEach(m => m.classList.remove('active')); document.getElementById('menu-' + id).classList.toggle('active'); }
    function showReactionPicker(e, id) { e.stopPropagation(); document.getElementById('menu-' + id).classList.remove('active'); document.getElementById('react-bar-' + id).classList.add('active'); }
    function addReaction(id, emoji) { const container = document.getElementById('reactions-' + id); container.style.display = 'flex'; container.innerHTML += `<span>${emoji}</span>`; }

    function startEdit(id) {
        isEditing = true;
        isReplying = false;
        editingId = id;
        
        const msgEl = document.querySelector(`[data-content-id="${id}"]`);
        
        const quoteBubble = msgEl.querySelector('.reply-quote-bubble');
        if (quoteBubble) {
            currentQuoteHtml = quoteBubble.outerHTML;
            let clone = msgEl.cloneNode(true);
            clone.querySelector('.reply-quote-bubble').remove();
            textContent = clone.innerText;
        } else {
            currentQuoteHtml = "";
            textContent = msgEl.innerText;
        }
        
        textContent = textContent.replace('üìé View Attachment', '').trim();
        textContent = textContent.replace(/\s*\(edited\)$/i, '').trim();
        
        document.getElementById('replyTargetUser').innerText = "Editing Message";
        document.getElementById('replyTargetText').innerText = textContent;
        document.getElementById('replyPreview').style.display = 'flex';
        
        const input = document.getElementById('messageInput');
        input.value = textContent;
        input.focus();
    }

    function pinMessage(id) {
        pinnedMessageId = id;
        const msgEl = document.querySelector(`[data-content-id="${id}"]`);
        let text = msgEl ? msgEl.innerText : "";
        text = text.replace(/Replying to message[\s\S]*?\n/, '').trim();
        text = text.replace('üìé View Attachment', '').trim();
        text = text.replace(/\s*\(edited\)$/i, '').trim();
        document.getElementById('pinnedTextContent').innerText = text;
        document.getElementById('pinnedMessageBar').style.display = 'flex';
    }
    function unpinMessage() { pinnedMessageId = null; document.getElementById('pinnedMessageBar').style.display = 'none'; }
    function scrollToPinned() { if(pinnedMessageId) document.getElementById('msg-' + pinnedMessageId).scrollIntoView({behavior: 'smooth', block: 'center'}); }

    async function deleteMessage(id) {
        if(confirm("Delete this message?")) {
            const res = await fetch('/delete_message/' + id, {method: 'POST'});
            if((await res.json()).success) { document.getElementById('msg-' + id).remove(); if(pinnedMessageId === id) unpinMessage(); showNotification("Success", "Message deleted"); }
        }
    }
    

    document.getElementById('messageForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const input = document.getElementById('messageInput');
        const content = input.value.trim();
        const file = document.getElementById('fileInput').files[0];
        if (!content && !file) return;

        const formData = new FormData(this);

        if (isEditing) {
            let finalContent = content;
            if (currentQuoteHtml) finalContent = currentQuoteHtml + finalContent; // Keep quote if existed
            finalContent += ' <span class="edited-label">(edited)</span>';
            formData.set('content', finalContent);
            
            const res = await fetch('/edit_message/' + editingId, { method: 'POST', body: formData });
            if((await res.json()).success) window.location.reload();
            return;
        }

        if (isReplying) {
            const quoteHtml = `<div class="reply-quote-bubble"><span class="reply-quote-sender">Replying to message</span><span>${replyText}</span></div>${content}`;
            formData.set('content', quoteHtml);
        } else if (file && !content) {
            formData.set('content', '[File Attachment]');
        }

        try {
            const res = await fetch('/send_message', { method: 'POST', body: formData });
            if ((await res.json()).success) window.location.reload();
        } catch (err) {}
    });

    function showNotification(type, title, message) {
        const toast = document.getElementById('notificationToast');
        document.getElementById('notificationTitle').textContent = title;
        document.getElementById('notificationMessage').textContent = message;
        toast.classList.remove('success', 'error');
        toast.classList.add(type, 'active');
        setTimeout(() => toast.classList.remove('active'), 3000);
    }
    const fileInput = document.getElementById('fileInput');
    fileInput.addEventListener('change', (e) => { if (e.target.files[0]) { document.getElementById('fileName').textContent = e.target.files[0].name; document.getElementById('filePreview').style.display = 'flex'; } });
    function removeFile() { fileInput.value = ''; document.getElementById('filePreview').style.display = 'none'; }
    
    function openAddContactModal() { document.getElementById('addContactModal').classList.add('active'); document.getElementById('conversationMenu').classList.remove('active'); }
    function closeAddContactModal() { document.getElementById('addContactModal').classList.remove('active'); }
    function openNewGroupModal() { document.getElementById('newGroupModal').classList.add('active'); document.getElementById('conversationMenu').classList.remove('active'); }
    function closeNewGroupModal() { document.getElementById('newGroupModal').classList.remove('active'); }

    // Forms
    document.getElementById('newGroupForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        try {
            const res = await fetch('/create_group', { method: 'POST', body: new FormData(this) });
            const data = await res.json();
            
            if (data.success) { 
                showNotification('success', 'Group Created', data.message); 
                setTimeout(() => window.location.href = '/messages', 2500); 
            } else {
                showNotification('error', 'Error', data.message);
            }
        } catch(err) {
            showNotification('error', 'Error', 'Failed to create group');
        }
    });

    document.getElementById('addContactForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        try {
            const res = await fetch('/add_contact', { method: 'POST', body: new FormData(this) });
            const data = await res.json();
            
            if (data.success) { 
                showNotification('success', 'Status', data.message); 
                setTimeout(() => window.location.reload(), 2500);
            } else {
                showNotification('error', 'Error', data.message);
            }
        } catch(err) {
            showNotification('error', 'Error', 'Failed to send request');
        }
    });
    
    // ‚¨áÔ∏è NEW: Live Search Logic
    const searchInput = document.getElementById('userSearchInput');
    const searchResults = document.getElementById('searchResults');
    let searchTimeout = null;

    if(searchInput) {
        searchInput.addEventListener('input', function(e) {
            const query = e.target.value.trim();
            
            if (searchTimeout) clearTimeout(searchTimeout);
            
            if (query.length === 0) {
                searchResults.style.display = 'none';
                searchResults.innerHTML = '';
                return;
            }

            searchTimeout = setTimeout(async () => {
                try {
                    const res = await fetch(`/search_users?q=${encodeURIComponent(query)}`);
                    const data = await res.json();
                    
                    searchResults.innerHTML = '';
                    
                    if (data.results.length > 0) {
                        searchResults.style.display = 'block';
                        data.results.forEach(user => {
                            const div = document.createElement('div');
                            div.style.cssText = 'padding:10px; display:flex; align-items:center; gap:10px; cursor:pointer; border-bottom:1px solid #f3f4f6;';
                            div.onmouseover = () => div.style.backgroundColor = '#f9fafb';
                            div.onmouseout = () => div.style.backgroundColor = 'white';
                            
                            // Main click goes to profile
                            div.onclick = () => window.location.href = `/profile/${user.username}`;
                            
                            // ‚¨áÔ∏è UPDATED HTML structure to include Plus Button
                            div.innerHTML = `
                                <div style="width:30px; height:30px; border-radius:50%; background:#e5e7eb; display:flex; align-items:center; justify-content:center; overflow:hidden;">
                                    <img src="/static/uploads/${user.profile_picture}" onerror="this.style.display='none'" style="width:100%; height:100%; object-fit:cover;">
                                    <span style="font-size:12px; font-weight:bold; color:#6b7280; display:${user.profile_picture !== 'default.jpg' ? 'none' : 'block'}">${user.username[0].toUpperCase()}</span>
                                </div>
                                <div style="flex:1;">
                                    <div style="font-size:13px; font-weight:600; color:#1f2937;">${user.username}</div>
                                    <div style="font-size:11px; color:#6b7280;">${user.fullname}</div>
                                </div>
                                <div class="add-user-btn" style="padding: 8px; cursor:pointer; color:#6366f1; border-radius:50%; display:flex; align-items:center; justify-content:center; transition:background 0.2s;"
                                     onclick="event.stopPropagation(); triggerAddContactFromSearch('${user.id}', '${user.username}')"
                                     onmouseover="this.style.backgroundColor='#e0e7ff'"
                                     onmouseout="this.style.backgroundColor='transparent'">
                                     <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                                </div>
                            `;
                            searchResults.appendChild(div);
                        });
                    } else {
                        searchResults.style.display = 'block';
                        searchResults.innerHTML = '<div style="padding:15px; text-align:center; color:#9ca3af; font-size:13px;">No users found</div>';
                    }
                } catch (err) {
                    console.error("Search failed", err);
                }
            }, 300);
        });

        document.addEventListener('click', function(e) {
            if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
                searchResults.style.display = 'none';
            }
        });
    }

    const area = document.getElementById('messagesArea');
    if(area) area.scrollTop = area.scrollHeight;
</script>
</body>
</html>